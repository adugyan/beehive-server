#!/usr/bin/env python3
import publishing
import argparse
from datetime import datetime
import sys


def load_timestamp(timestamp):
    return datetime.strptime(timestamp, '%Y/%m/%d %H:%M:%S')


if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('metapath', help='path for project metadata files')
    args = parser.parse_args()

    nodes = publishing.load_project_metadata(args.metapath)
    nodes_by_id = {node['node_id']: node for node in nodes}

    def isviewable(line):
        fields = line.split(';')
        node_id = fields[0]
        timestamp = load_timestamp(fields[1])

        if node_id not in nodes_by_id:
            return False

        node = nodes_by_id[node_id]

        return any(timestamp in interval for interval in node['commissioned'])

    for line in filter(isviewable, sys.stdin.readlines()):
        sys.stdout.write(line)
