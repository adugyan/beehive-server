#!/usr/bin/env python3
import argparse
from cassandra.cluster import Cluster
import configparser
import csv
import json
import datetime
import os
import subprocess
import sys


def parse_int_string(s):
    if s.startswith('0x'):
        return int(s, 16)
    return int(s)


def load_sdf_file(path):
    results = []

    with open(path) as file:
        reader = csv.DictReader(file)

        for row in reader:
            results.append({
                'sensor_id': parse_int_string(row['sensor_id']),
                'sensor_name': row['sensor_name'].strip(),
                'parameter_id': parse_int_string(row['parameter_id']),
                'parameter_name': row['parameter_name'].strip(),
            })

    return results


parser = argparse.ArgumentParser()
parser.add_argument('sdf')
parser.add_argument('plugins', nargs='+')
args = parser.parse_args()


sdf = load_sdf_file(args.sdf)
id_to_name = {}

for r in sdf:
    id_to_name[(r['sensor_id'], r['parameter_id'])] = (r['sensor_name'], r['parameter_name'])

executables = {}

# move into load configuration
for p in (os.path.abspath(p) for p in args.plugins):
    executable = os.path.join(p, 'plugin_bin', 'plugin_beehive')
    if not os.path.exists(executable):
        print(p, 'missing beehive plugin', file=sys.stderr)
        continue

    config = configparser.ConfigParser()
    config.read(os.path.join(p, 'plugin.ver'))
    section = config['plugin']

    plugin = (section['id'], section['version'])
    executables[plugin] = executable

cluster = Cluster()
session = cluster.connect('waggle')

query = 'SELECT plugin_id, plugin_version, data FROM data_messages_v2 WHERE node_id=%s AND date=%s'

results = []
results_by_plugin = {}

writer = csv.writer(sys.stdout)

logfile = open('plugins.log', 'a')

seen = set()

for line in sys.stdin:
    node_id, date = line.split()

    for r in session.execute(query, (node_id, date)):
        plugin = (r.plugin_id, r.plugin_version)

        if plugin not in results_by_plugin:
            results_by_plugin[plugin] = []

        if (node_id, date, plugin) not in seen:
            seen.add((node_id, date, plugin))
            print(node_id, date, *plugin, file=logfile)
            logfile.flush()

        results_by_plugin[plugin].append(r.data)
        results.append(r.data)

    for plugin, results in results_by_plugin.items():
        if plugin not in executables:
            print('no plugin for', plugin, file=sys.stderr)
            continue

        input = b''.join(results)
        output = subprocess.check_output([executables[plugin]], input=input)
        rows = json.loads(output)

        for row in rows:
            try:
                sensor, parameter = id_to_name[(row['sensor'], row['parameter'])]
            except KeyError:
                sensor, parameter = row['sensor'], row['parameter']

            ts = datetime.datetime.fromtimestamp(row['timestamp'])

            writer.writerow([
                ts.strftime('%Y/%m/%d %H:%M:%S'),
                node_id[-12:].lower(),
                row['subsystem'],
                sensor,
                parameter,
                row['value_raw'],
                row['value_hrf'],
            ])
